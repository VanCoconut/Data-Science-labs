CREATE MATERIALIZED VIEW ViewAttivita 
BUILD IMMEDIATE REFRESH FAST ON COMMIT AS
SELECT REgione-Sede,,Anno,Azienda-Citta,Dimensioni-Azienda, SUM(CostoTotale)as CT,
 SUM(NumeroOre) AS NO, CategoriaConsulenti,Categoria-Innovazione,
6-Mesi,Fascia-Eta,SUM(Numero-Consulenti) AS NC
FROM SEDE-AZIENDA, TEMPO,ATTIVITA-CONSULENZA,TIPOLOGIA-CONSULENZA,CARATTERISTICHE-CONSULENTI
WHERE join
GROUP BY  Azienza-Citta,Anno,Dimensioni-Azienda,Regione-Sede,CategoriaConsulenti,
          CategoriaInnovazione,6-mesi,FasciaEta

CREATE OR REPLACE TRIGGER T1 
AFTER INSERT ON ATTIVITA-CONSULENTI
FOR EACH ROW

DECLARE
VAR_ANNO VARCHAR(20),
VAR_6-,ESI VARCAHR(20),
VAR_CITTA VARCAHR(20),
VAR_REGIONE VARCHAR(20),
VAR_DIMENIONE VACAHR(20),S
VAR_CATEGORIA VARCHAR(20),
VAR_INNOVAZIONE VARCHAR(20);
N NUMBER;

BEGIN

SELECT ANNO,6-MESI
INTO VAR_ANNO,CAR_6-MESI
FROM TEMPO 
WHERE ID_TEMPO=:NEW.ID_TEMPO

SELECT CITTA-SEDE-AZIENDA,REGIONE-SEDE-AZIENDA,DIEMNSIONE-AZIENDA
INTO VAR_CITTA,VAR_REGIONE,VAR_DIMENSIONE
FORM SEDE_AZIENDA
WHERE ID_SEDE_AZIENDA=:NEW.ID_SEDE_AZIENDA

SELECT CATEGORIA-CONSULENTI
INTO VAR_CATEGORIA
FROM CARATTERISTICHE-CONSULENTI
WHERE ID_CAR_CONSULENTI =:NEW_ID_CAR_CONSULENTI

SELECT CATEGORIA_INNOVAZIONE
INTO VAR_INNOVAZIONE
FROM TIPOLOGIA-CONSULENZA
WHERE ID_TIPOLOGIA_CONSULENTI=:NEW_ID_TIPOLOGIA_CONSUELNTI

SELECT COUNT(*) AS N
FROM ATTIVITA-CONSULENTI
WHERE 6-MESI=VAR_6-MESI AND SEDE_AZIENDA_CITTA=VAR_CITTA AND CATEGORIA-CONSULENTI=VAR_CATEGORIA AND TIPOLOGIA_CONSULENZA=VAR_INNOVAZIONE

IF(N>0)
	UPDATE ViewAttivita 
	SET CT=CT+:NEW.COSTO_TOTALE , NO=NO+:NEW.NUMERO_ORE, NC=NC+:NEW.NUMERO_CONSULENTI
        WHERE 6-MESI=VAR_6-MESI AND SEDE_AZIENDA_CITTA=VAR_CITTA AND CATEGORIA-CONSULENTI=VAR_CATEGORIA AND TIPOLOGIA_CONSULENZA=VAR_INNOVAZIONE

ELSE

	INSERT INTO ViewAttvita (REgione-Sede,Anno,Azienda-Citta,Dimensioni-Azienda, CT,NO, CategoriaConsulenti,Categoria-Innovazione,6-Mesi,Fascia-Eta, NC) 
	VALUES (VAR_ANNO , VAR_6-,ESI ,VAR_CITTA,VAR_REGIONE,VAR_DIMENIONE ,VAR_CATEGORIA ,VAR_INNOVAZIONE,:NEW.COSTO_TOTALE,:NEW.NUMERO_ORE,:NEW.NUMERO_CONSULENTI)


END IF

END
