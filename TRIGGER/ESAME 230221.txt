ESAME 23/02/21

SELECT AREAGEOGRAFICA,REGIONE,ANNO,SUM(#RICHIESTECONCLUSE) AS TOTRC,SUM(IMPORTOTOTAPPROVATO) AS TOTIA, SUM(DURATATOTPROCESSO) AS TOTDA,DANNIACCIDENTALI,FURTO,MESE,
	SUM(IMPORTOTOTRICHIESTO) AS TOTIR,ANNO,6-MESI

FROM RICHIESTE-RIMBORSO R, NEGOZIO N, TEMPO T,JUNK-CARAT-COPERTURE-ASSICURATIVE J
WHERE R.IDTEMPO=T.IDTEMPO AND N.IDNEGOZIO=R.IDNEGOZIO AND R.IDJCCA=J.IDJCCA
GROUP BY AREAGEOGRAFICA,REGIONE,ANNO,DANNIACCIDENTALI,FURTO,MESE,ANNO,6-MESI

CREATE OR REPLACE TRIGGER T1
AFTER INSERT ON RICHIESTE-RIMBORSO
FOR EACH ROW

DECLARE


BEGIN 

SELECT AREAGEOGRAFICA, REGIONE INTO VARA,VARR
FROM NEGOZIO
WHERE IDNEGOZIO=:NEW.IDNEGOZIO

SELECT ANNO,MESE,6-MESI INT VARANNO,VARM,VAR6
FROM TEMPO
WHERE IDTEMPO=:NEW.IDTEMPO

SELECT DANNIACCIDENTALI,FURTO INTO VARD,VARF
FROM JUNK-CARAT-COPERTURE-ASSICURATIVE
WHERE IDJCCA=:NEW.IDJCCA

SELECT COUNT(*) INTO N
FROM VIEW
WHERE MESE=VARM AND VARD=DANNIACCIDENTALI AND VARF=FURTO AND VARR=REGIONE

IF(N>0)
	UPDATE VIEW
	SET TOTRC+=:NEW.RICHIESTECONCLUSE, TOTIA+=:NEW.IMPORTOAPPROVATO, TOTDA+=:NEW.DURATAPROCESSO, TOTIR+=:NEW.IMPORTORICHIESTO
	WHERE MESE=VARM AND VARD=DANNIACCIDENTALI AND VARF=FURTO AND VARR=REGIONE

ELSE
	INSERT INTO VIEW(...) VALUES(VARM,VARANNO,VAR6,VARA,VARR,VARF,VARD,:NEW.RICHESTECONCLUSE,:NEW.IMPORTOAPPROVATO,:NEW.IMPORTOrICHIESTO,:NEW.DURATAPROCESSO)
ENF IF
END