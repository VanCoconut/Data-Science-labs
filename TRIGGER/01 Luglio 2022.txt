01 Luglio 2022

SELECT ANNO,REGIONESEDEAZIENDA,SUM(COSTOTOTALE)/COUNT(DISTINCT MESE),
	100*SUM(COSTOTOTALE)/SUM(SUM(COSTOTOTALE)) OVER (PARTITION BY ANNO,STATOSEDEAZIENDA),
	RANK() OVER(PARTITION BY ANNO ORDER BY SUM(NUMEROCONSULENTI)/COUNT(DISTINCT MESE) DESCENDING)

FROM CARATTERISTICHE-CONSULENTI CC, TEMPO T,ATTIVITA-DI.CONSULENZA A, SEDE-AZIENDA SA,
WHERE FASCIAETA="35-50" CATEGORIA-CONSULENTI=SPECIALIST AND T.IDTEMPO=A.IDTEMPO AND CC.IDCARCONSULENTI=A.IDCARCONSULENTI AND A.IDDSEDEAZIENDA=SA.IDSEDEAZIENDA
GROUP BY ANNO,REGIONESEDEAZIENDA, STATO

SELECT TIPOLOGIACONSULENZA, 4-MESI, SUM(NUMEROORE)/COUNT(DISTINCT MESE), 100*SUM(NUMEROORE)/SUM(SUM(NUMEROORE)) OVER (PARTITION BY ANNO,TIPOLOGIACONSULENZA),
	SUM(SUM(COSTOTOTALE)) OVER (PARTITION BY ANNO,TIPOLOGIACONSULENZA ORDER BY 4-MESI ROWS UNBOUNDED PRECEDING)

FROM TIPOLOGIA_CONSULENZA T, ATTIVITA-DI-CONSULENZA,TEMPO T
WHERE T.IDTEMPO=A.IDTEMPO AND T.IDTIPOLOGIACONSULENZA=A.IDTIPOLOGIACONSULENZA
GROUP BY TIPOLOGIACONSULENZA, 4-MESI,ANNO

SELECT 3-MESI,AZIENDA,100*SUM(COSTOTOTALE)/SUM(SUM(COSTOTOTALE)) OVER (PARTITION BY ANNO,AZIENDA), SUM(COSTOTOTALE)/SUM(NUMEROORE),
	RANK() OVER (PARTITION BY TIPOLOGIA-AZIENDA,3-MESI ORDER BY SUM(COSTOTOTALE) DESCENDING)	

FROM SEDE-AZIENDA S,ATTIVITA.DI.CONSULENZA A, TEMPO T
WHERE DIMENSIONE-AZIENDA>100 AND (ANNO="2021" OR ANNO="2020") AND S.IDSEDEAZIENDA=A.IDSEDEAZIENDA AND T.IDTEMPO=A.IDTEMPO 
GROUP BY 3-MESI,ANNO,TIPOLOGIA-AZIENDA,AZIENDA



VISTA


SELECT DIMENSIONE-AZIENDA,REGIONE-SEDE-AZIENDA, SUM(COSTOTOTALE) AS TOTC,SUM(NUEMROORE) TOTO,CITTA-SEDE-AZIENDA,ANNO, CATEGOIRA-	CONSULENTI, TIPOLOGIACONSULENZA, SUM(NUMEROCONSULENTI) AS TOTN,6-MESI,FASCIA-ETA	

FROM ATTIVITA-DI-CONSULENZA A, TEMPO T, CARATTERISTICHE-CONSULENTI C, SEDE-AZIENDA S, TIPOLOGIA-CONSULENZA T
WHERE A.IDTEMPO=T.IDTEMPO AND A.IDCARCOSNULENTI=C.IDCARCOSNULENTI AND A.IDSEDEAZIENDA=S.IDSEDEAZIENDA AND A.IDTIPOLOGIACONSULENZA=T.IDTIPOLOGIACOSNULENZA
GROUP BY 6-MESI,ANNO,CITTA-SEDE-AZIENDA,REGIONE.SEDE-AZIENDA,DIMENSIONE-AZIENDA,FASCIA-ETA,CATEGORIA-CONSULENTI, TIPOLOGIACOSNULENZA

CREATE OR REPLACE TRIGGER T1
AFTER INSERT ON ATTIVITA-DI-CONSUKENZA
FOR EACH ROW

DECLARE
VAR6,VARANNO,VARCITTA,VARREGIONE,VARF,VARC,VART VARCAHR(20);
VARDIMENSIONE,N INTEGER;

BEGIN

SELECT 6-MESI,ANNO INTO VAR6,VARANNO
FORM TEMPO
WHERE IDTEMPO=:NEW.IDTEMPO

SELECT CITTA-SEDE-AZIENDA,REGIONE.SEDE.AZNIENDA,DIMENSIONE-AZIENDA
INTO VARCITTA,VARREGIONE,VARDIMENSIONE
FROM SEDE-AZIENDA
WHERE IDESEDEAZIENDA=:NEW.IDSEDEAZIENDA

SELECT FASCIA-ETA, CARATEGORIA-CONSULENTI
INTO VARF,VARC
FROM CARATTERISTICHE-CONSULENTI
WHERE IDCARCONSULENTI=:NEW.IDCARCONSULENTI

SELECT TIPOLOGIACONSULENZA INT VART
FORM TIPOLOGIA-CONSULENZA
WHERE IDTIPOLOGIACOSNULENZA=:NEW.IDTIPOLOGIACOSNULENZA

SELECT COUNT(*) INT N
FROM VIEW
WHERE 6-MESI=VAR6 AND VARCITTA=CITTA-SEDE-AZIENDA AND VARDIMENSIONE=DIMENSIONE-AZIENDA AND VARF=FASCIA-ETA AND VARC=CATEGORIA-CONSULENTI AND VART = TIPOLOGIACONSULENZA

IF(N>0)
	UPDATE VIEW
	SET TOTC+=:NEW.COSTOTOTALE ,TOTO9=:NEW.NUMEROORE,TOTN+=NEW.NUMEROCONSULENTI
	WHERE 6-MESI=VAR6 AND VARCITTA=CITTA-SEDE-AZIENDA AND VARDIMENSIONE=DIMENSIONE-AZIENDA AND VARF=FASCIA-ETA AND VARC=CATEGORIA-CONSULENTI AND VART = TIPOLOGIACONSULENZA

ELSE
	INSERT INTO VIEW(...) VALUES 	(VAR6,VARANNO,VARCITTA,VARREGIONE,VARDIMENSIONE,VARF,VARC,VART,:NEW.COSTOTOTALE,:NEW.NUMEROORE,:NEW.NUMEROCOSNULENTI)

END IF
END


